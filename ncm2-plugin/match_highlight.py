# -*- coding: utf-8 -*-

def wrap():
    from ncm2_core import ncm2_core
    from ncm2 import getLogger
    import vim

    index_map = {
            'bold': 1,
            'sans-serif': 2,
            'sans-serif-bold': 3,
            'mono-space': 4,
            'double-struck': 5
            }

    replace_map = [('A', 'ð€', 'ð– ', 'ð—”', 'ð™°', 'ð”¸'),
                   ('B', 'ð', 'ð–¡', 'ð—•', 'ð™±', 'ð”¹'),
                   ('C', 'ð‚', 'ð–¢', 'ð—–', 'ð™²', 'â„‚'),
                   ('D', 'ðƒ', 'ð–£', 'ð——', 'ð™³', 'ð”»'),
                   ('E', 'ð„', 'ð–¤', 'ð—˜', 'ð™´', 'ð”¼'),
                   ('F', 'ð…', 'ð–¥', 'ð—™', 'ð™µ', 'ð”½'),
                   ('G', 'ð†', 'ð–¦', 'ð—š', 'ð™¶', 'ð”¾'),
                   ('H', 'ð‡', 'ð–§', 'ð—›', 'ð™·', 'â„'),
                   ('I', 'ðˆ', 'ð–¨', 'ð—œ', 'ð™¸', 'ð•€'),
                   ('J', 'ð‰', 'ð–©', 'ð—', 'ð™¹', 'ð•'),
                   ('K', 'ðŠ', 'ð–ª', 'ð—ž', 'ð™º', 'ð•‚'),
                   ('L', 'ð‹', 'ð–«', 'ð—Ÿ', 'ð™»', 'ð•ƒ'),
                   ('M', 'ðŒ', 'ð–¬', 'ð— ', 'ð™¼', 'ð•„'),
                   ('N', 'ð', 'ð–­', 'ð—¡', 'ð™½', 'â„•'),
                   ('O', 'ðŽ', 'ð–®', 'ð—¢', 'ð™¾', 'ð•†'),
                   ('P', 'ð', 'ð–¯', 'ð—£', 'ð™¿', 'â„™'),
                   ('Q', 'ð', 'ð–°', 'ð—¤', 'ðš€', 'â„š'),
                   ('R', 'ð‘', 'ð–±', 'ð—¥', 'ðš', 'â„'),
                   ('S', 'ð’', 'ð–²', 'ð—¦', 'ðš‚', 'ð•Š'),
                   ('T', 'ð“', 'ð–³', 'ð—§', 'ðšƒ', 'ð•‹'),
                   ('U', 'ð”', 'ð–´', 'ð—¨', 'ðš„', 'ð•Œ'),
                   ('V', 'ð•', 'ð–µ', 'ð—©', 'ðš…', 'ð•'),
                   ('W', 'ð–', 'ð–¶', 'ð—ª', 'ðš†', 'ð•Ž'),
                   ('X', 'ð—', 'ð–·', 'ð—«', 'ðš‡', 'ð•'),
                   ('Y', 'ð˜', 'ð–¸', 'ð—¬', 'ðšˆ', 'ð•'),
                   ('Z', 'ð™', 'ð–¹', 'ð—­', 'ðš‰', 'â„¤'),
                   ('a', 'ðš', 'ð–º', 'ð—®', 'ðšŠ', 'ð•’'),
                   ('b', 'ð›', 'ð–»', 'ð—¯', 'ðš‹', 'ð•“'),
                   ('c', 'ðœ', 'ð–¼', 'ð—°', 'ðšŒ', 'ð•”'),
                   ('d', 'ð', 'ð–½', 'ð—±', 'ðš', 'ð••'),
                   ('e', 'ðž', 'ð–¾', 'ð—²', 'ðšŽ', 'ð•–'),
                   ('f', 'ðŸ', 'ð–¿', 'ð—³', 'ðš', 'ð•—'),
                   ('g', 'ð ', 'ð—€', 'ð—´', 'ðš', 'ð•˜'),
                   ('h', 'ð¡', 'ð—', 'ð—µ', 'ðš‘', 'ð•™'),
                   ('i', 'ð¢', 'ð—‚', 'ð—¶', 'ðš’', 'ð•š'),
                   ('j', 'ð£', 'ð—ƒ', 'ð—·', 'ðš“', 'ð•›'),
                   ('k', 'ð¤', 'ð—„', 'ð—¸', 'ðš”', 'ð•œ'),
                   ('l', 'ð¥', 'ð—…', 'ð—¹', 'ðš•', 'ð•'),
                   ('m', 'ð¦', 'ð—†', 'ð—º', 'ðš–', 'ð•ž'),
                   ('n', 'ð§', 'ð—‡', 'ð—»', 'ðš—', 'ð•Ÿ'),
                   ('o', 'ð¨', 'ð—ˆ', 'ð—¼', 'ðš˜', 'ð• '),
                   ('p', 'ð©', 'ð—‰', 'ð—½', 'ðš™', 'ð•¡'),
                   ('q', 'ðª', 'ð—Š', 'ð—¾', 'ðšš', 'ð•¢'),
                   ('r', 'ð«', 'ð—‹', 'ð—¿', 'ðš›', 'ð•£'),
                   ('s', 'ð¬', 'ð—Œ', 'ð˜€', 'ðšœ', 'ð•¤'),
                   ('t', 'ð­', 'ð—', 'ð˜', 'ðš', 'ð•¥'),
                   ('u', 'ð®', 'ð—Ž', 'ð˜‚', 'ðšž', 'ð•¦'),
                   ('v', 'ð¯', 'ð—', 'ð˜ƒ', 'ðšŸ', 'ð•§'),
                   ('w', 'ð°', 'ð—', 'ð˜„', 'ðš ', 'ð•¨'),
                   ('x', 'ð±', 'ð—‘', 'ð˜…', 'ðš¡', 'ð•©'),
                   ('y', 'ð²', 'ð—’', 'ð˜†', 'ðš¢', 'ð•ª'),
                   ('z', 'ð³', 'ð—“', 'ð˜‡', 'ðš£', 'ð•«'),
                   ('0', 'ðŸŽ', 'ðŸ¢', 'ðŸ¬', 'ðŸ¶', 'ðŸ˜'),
                   ('1', 'ðŸ', 'ðŸ£', 'ðŸ­', 'ðŸ·', 'ðŸ™'),
                   ('2', 'ðŸ', 'ðŸ¤', 'ðŸ®', 'ðŸ¸', 'ðŸš'),
                   ('3', 'ðŸ‘', 'ðŸ¥', 'ðŸ¯', 'ðŸ¹', 'ðŸ›'),
                   ('4', 'ðŸ’', 'ðŸ¦', 'ðŸ°', 'ðŸº', 'ðŸœ'),
                   ('5', 'ðŸ“', 'ðŸ§', 'ðŸ±', 'ðŸ»', 'ðŸ'),
                   ('6', 'ðŸ”', 'ðŸ¨', 'ðŸ²', 'ðŸ¼', 'ðŸž'),
                   ('7', 'ðŸ•', 'ðŸ©', 'ðŸ³', 'ðŸ½', 'ðŸŸ'),
                   ('8', 'ðŸ–', 'ðŸª', 'ðŸ´', 'ðŸ¾', 'ðŸ '),
                   ('9', 'ðŸ—', 'ðŸ«', 'ðŸµ', 'ðŸ¿', 'ðŸ¡'), ]

    old_matches_filter = ncm2_core.matches_filter

    def new_matches_filter(*args):
        data = args[0]
        matches = args[-1]
        matches = old_matches_filter(*args)
        idx = index_map[data['match_highlight']]

        for m in matches:
            ud = m['user_data']
            key = ud.get('match_key', 'abbr')
            hl = ud.get('match_highlight', [])
            if key == 'word':
                continue
            for b, e in hl:
                sub = m[key][b:e]
                for rp in replace_map:
                    sub = sub.replace(rp[0], rp[idx])
                a = m[key]

                # somehow the last highligted character is not properly
                # displayed in the terminal, append a space as workaround
                m[key] = a[:b] + sub + (a[e:] or ' ')

        return matches

    ncm2_core.matches_filter = new_matches_filter

    vim.command(r'''
        let g:ncm2#match_highlight = get(g:, "ncm2#match_highlight", "double-struck")
        call ncm2#hook_coredata(1, ['complete', 'on_complete'], 'match_highlight', {d -> extend(d, {'match_highlight': g:ncm2#match_highlight}, "force")})
    ''')


wrap()
