# -*- coding: utf-8 -*-

def wrap():
    from ncm2_core import ncm2_core
    from ncm2 import getLogger
    import vim

    index_map = {
            'bold': 1,
            'sans-serif': 2,
            'sans-serif-bold': 3,
            'mono-space': 4,
            'double-struck': 5
            }

    replace_map = [('A', 'ğ€', 'ğ– ', 'ğ—”', 'ğ™°', 'ğ”¸'),
                   ('B', 'ğ', 'ğ–¡', 'ğ—•', 'ğ™±', 'ğ”¹'),
                   ('C', 'ğ‚', 'ğ–¢', 'ğ—–', 'ğ™²', 'â„‚'),
                   ('D', 'ğƒ', 'ğ–£', 'ğ——', 'ğ™³', 'ğ”»'),
                   ('E', 'ğ„', 'ğ–¤', 'ğ—˜', 'ğ™´', 'ğ”¼'),
                   ('F', 'ğ…', 'ğ–¥', 'ğ—™', 'ğ™µ', 'ğ”½'),
                   ('G', 'ğ†', 'ğ–¦', 'ğ—š', 'ğ™¶', 'ğ”¾'),
                   ('H', 'ğ‡', 'ğ–§', 'ğ—›', 'ğ™·', 'â„'),
                   ('I', 'ğˆ', 'ğ–¨', 'ğ—œ', 'ğ™¸', 'ğ•€'),
                   ('J', 'ğ‰', 'ğ–©', 'ğ—', 'ğ™¹', 'ğ•'),
                   ('K', 'ğŠ', 'ğ–ª', 'ğ—', 'ğ™º', 'ğ•‚'),
                   ('L', 'ğ‹', 'ğ–«', 'ğ—Ÿ', 'ğ™»', 'ğ•ƒ'),
                   ('M', 'ğŒ', 'ğ–¬', 'ğ— ', 'ğ™¼', 'ğ•„'),
                   ('N', 'ğ', 'ğ–­', 'ğ—¡', 'ğ™½', 'â„•'),
                   ('O', 'ğ', 'ğ–®', 'ğ—¢', 'ğ™¾', 'ğ•†'),
                   ('P', 'ğ', 'ğ–¯', 'ğ—£', 'ğ™¿', 'â„™'),
                   ('Q', 'ğ', 'ğ–°', 'ğ—¤', 'ğš€', 'â„š'),
                   ('R', 'ğ‘', 'ğ–±', 'ğ—¥', 'ğš', 'â„'),
                   ('S', 'ğ’', 'ğ–²', 'ğ—¦', 'ğš‚', 'ğ•Š'),
                   ('T', 'ğ“', 'ğ–³', 'ğ—§', 'ğšƒ', 'ğ•‹'),
                   ('U', 'ğ”', 'ğ–´', 'ğ—¨', 'ğš„', 'ğ•Œ'),
                   ('V', 'ğ•', 'ğ–µ', 'ğ—©', 'ğš…', 'ğ•'),
                   ('W', 'ğ–', 'ğ–¶', 'ğ—ª', 'ğš†', 'ğ•'),
                   ('X', 'ğ—', 'ğ–·', 'ğ—«', 'ğš‡', 'ğ•'),
                   ('Y', 'ğ˜', 'ğ–¸', 'ğ—¬', 'ğšˆ', 'ğ•'),
                   ('Z', 'ğ™', 'ğ–¹', 'ğ—­', 'ğš‰', 'â„¤'),
                   ('a', 'ğš', 'ğ–º', 'ğ—®', 'ğšŠ', 'ğ•’'),
                   ('b', 'ğ›', 'ğ–»', 'ğ—¯', 'ğš‹', 'ğ•“'),
                   ('c', 'ğœ', 'ğ–¼', 'ğ—°', 'ğšŒ', 'ğ•”'),
                   ('d', 'ğ', 'ğ–½', 'ğ—±', 'ğš', 'ğ••'),
                   ('e', 'ğ', 'ğ–¾', 'ğ—²', 'ğš', 'ğ•–'),
                   ('f', 'ğŸ', 'ğ–¿', 'ğ—³', 'ğš', 'ğ•—'),
                   ('g', 'ğ ', 'ğ—€', 'ğ—´', 'ğš', 'ğ•˜'),
                   ('h', 'ğ¡', 'ğ—', 'ğ—µ', 'ğš‘', 'ğ•™'),
                   ('i', 'ğ¢', 'ğ—‚', 'ğ—¶', 'ğš’', 'ğ•š'),
                   ('j', 'ğ£', 'ğ—ƒ', 'ğ—·', 'ğš“', 'ğ•›'),
                   ('k', 'ğ¤', 'ğ—„', 'ğ—¸', 'ğš”', 'ğ•œ'),
                   ('l', 'ğ¥', 'ğ—…', 'ğ—¹', 'ğš•', 'ğ•'),
                   ('m', 'ğ¦', 'ğ—†', 'ğ—º', 'ğš–', 'ğ•'),
                   ('n', 'ğ§', 'ğ—‡', 'ğ—»', 'ğš—', 'ğ•Ÿ'),
                   ('o', 'ğ¨', 'ğ—ˆ', 'ğ—¼', 'ğš˜', 'ğ• '),
                   ('p', 'ğ©', 'ğ—‰', 'ğ—½', 'ğš™', 'ğ•¡'),
                   ('q', 'ğª', 'ğ—Š', 'ğ—¾', 'ğšš', 'ğ•¢'),
                   ('r', 'ğ«', 'ğ—‹', 'ğ—¿', 'ğš›', 'ğ•£'),
                   ('s', 'ğ¬', 'ğ—Œ', 'ğ˜€', 'ğšœ', 'ğ•¤'),
                   ('t', 'ğ­', 'ğ—', 'ğ˜', 'ğš', 'ğ•¥'),
                   ('u', 'ğ®', 'ğ—', 'ğ˜‚', 'ğš', 'ğ•¦'),
                   ('v', 'ğ¯', 'ğ—', 'ğ˜ƒ', 'ğšŸ', 'ğ•§'),
                   ('w', 'ğ°', 'ğ—', 'ğ˜„', 'ğš ', 'ğ•¨'),
                   ('x', 'ğ±', 'ğ—‘', 'ğ˜…', 'ğš¡', 'ğ•©'),
                   ('y', 'ğ²', 'ğ—’', 'ğ˜†', 'ğš¢', 'ğ•ª'),
                   ('z', 'ğ³', 'ğ—“', 'ğ˜‡', 'ğš£', 'ğ•«'),
                   ('0', 'ğŸ', 'ğŸ¢', 'ğŸ¬', 'ğŸ¶', 'ğŸ˜'),
                   ('1', 'ğŸ', 'ğŸ£', 'ğŸ­', 'ğŸ·', 'ğŸ™'),
                   ('2', 'ğŸ', 'ğŸ¤', 'ğŸ®', 'ğŸ¸', 'ğŸš'),
                   ('3', 'ğŸ‘', 'ğŸ¥', 'ğŸ¯', 'ğŸ¹', 'ğŸ›'),
                   ('4', 'ğŸ’', 'ğŸ¦', 'ğŸ°', 'ğŸº', 'ğŸœ'),
                   ('5', 'ğŸ“', 'ğŸ§', 'ğŸ±', 'ğŸ»', 'ğŸ'),
                   ('6', 'ğŸ”', 'ğŸ¨', 'ğŸ²', 'ğŸ¼', 'ğŸ'),
                   ('7', 'ğŸ•', 'ğŸ©', 'ğŸ³', 'ğŸ½', 'ğŸŸ'),
                   ('8', 'ğŸ–', 'ğŸª', 'ğŸ´', 'ğŸ¾', 'ğŸ '),
                   ('9', 'ğŸ—', 'ğŸ«', 'ğŸµ', 'ğŸ¿', 'ğŸ¡'), ]

    old_matches_filter = ncm2_core.matches_filter

    def new_matches_filter(data, sr, base, matches):
        matches = old_matches_filter(data, sr, base, matches)
        idx = index_map[data['match_highlight']]

        for i in range(len(matches)):
            m = matches[i]
            if m['abbr'] != m['word']:
                continue
            if 'match_highlight' not in m['user_data']:
                continue
            hl = m['user_data']['match_highlight']
            for b, e in hl:
                sub = m['abbr'][b:e]
                for rp in replace_map:
                    sub = sub.replace(rp[0], rp[idx])
                a = m['abbr']

                # somehow the last highligted character is not properly
                # displayed in the terminal, append a space as workaround
                matches[i]['abbr'] = a[:b] + sub + (a[e:] or ' ')

        return matches

    ncm2_core.matches_filter = new_matches_filter

    vim.command(r'''
        let g:ncm2#match_highlight = get(g:, "ncm2#match_highlight", "double-struck")
        autocmd User Ncm2CoreData let g:ncm2#core_data['match_highlight'] = g:ncm2#match_highlight
    ''')


wrap()
